<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Camera Prompt ‚Äî Baseline DEBUG v2</title>
<style>
  :root{--bg:#0a0e19;--fg:#eaf0ff;--muted:#9eb2d2;--ok:#66f2b0;--warn:#ffd166;--err:#ff6b6b;--glass:rgba(255,255,255,.06);--brd:rgba(255,255,255,.14)}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 70% 10%, #162037 0%, #0a0e19 40%, #060912 100%);color:var(--fg);font:500 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto}
  header{padding:14px 16px;border-bottom:1px solid var(--brd);background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));backdrop-filter:blur(8px);z-index:10}
  h1{margin:0;font-size:18px}
  main{display:grid;place-items:center;padding:16px}
  .panel{max-width:980px;width:min(98vw,980px);border:1px solid var(--brd);border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));box-shadow:0 30px 120px rgba(0,0,0,.55);padding:16px;z-index:10}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .btn{appearance:none;border:1px solid var(--brd);background:var(--glass);color:var(--fg);padding:.7rem 1rem;border-radius:12px;cursor:pointer;transition:.15s;position:relative;z-index:11}
  .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.12)}
  .btn[disabled]{opacity:.5;cursor:not-allowed;transform:none}
  .tag{display:inline-flex;gap:.35rem;align-items:center;padding:.25rem .6rem;border:1px solid var(--brd);border-radius:999px;background:var(--glass)}
  .ok{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}
  #video{width:min(85vw,720px);max-height:60vh;border-radius:12px;border:1px solid var(--brd);display:none;box-shadow:0 16px 60px rgba(0,0,0,.6)}
  #diag{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  #notes{opacity:.85;margin-top:12px}
  footer{padding:10px 16px;display:flex;gap:8px;justify-content:center}
  .monosmall{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;white-space:pre-wrap;background:rgba(255,255,255,.05);border:1px solid var(--brd);border-radius:12px;padding:8px;max-height:30vh;overflow:auto}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>CAMERA ‚Äî DEBUG v2 (–∂—ë—Å—Ç–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥)</h1>
    </header>
    <main>
      <div class="panel">
        <div class="row" style="margin-bottom:10px">
          <button id="start" class="btn">‚ñ∂ –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É (–æ–±—ã—á–Ω—ã–π)</button>
          <button id="startMin" class="btn">‚ñ∂ –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É (–º–∏–Ω–∏–º—É–º)</button>
          <button id="retry" class="btn">‚Üª –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
          <button id="stop" class="btn" disabled>‚èπ –í—ã–∫–ª—é—á–∏—Ç—å</button>
          <button id="copy" class="btn">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</button>
          <span id="status" class="tag warn">–ì–æ—Ç–æ–≤–æ</span>
        </div>
        <div id="diag"></div>
        <video id="video" playsinline muted></video>
        <div id="notes">
          <ul>
            <li>–î–∏–∞–ª–æ–≥ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ <b>HTTPS</b> –∏–ª–∏ <b>localhost</b>. –ù–∞ <code>file://</code> –∏ <code>http://</code> ‚Äî –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ –±—É–¥–µ—Ç.</li>
            <li>–ï—Å–ª–∏ —Ä–∞–Ω–µ–µ –Ω–∞–∂–∏–º–∞–ª(–∞) ¬´–ù–µ —Ä–∞–∑—Ä–µ—à–∞—Ç—å¬ª ‚Äî —Å–±—Ä–æ—Å—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–∞–π—Ç–∞ (–∑–Ω–∞—á–æ–∫ –∑–∞–º–∫–∞ ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞ ‚Üí –ö–∞–º–µ—Ä–∞ ‚Üí –°–ø—Ä–æ—Å–∏—Ç—å/–†–∞–∑—Ä–µ—à–∏—Ç—å).</li>
            <li>–ï—Å–ª–∏ —ç—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ <i>iframe</i>, —É —Ñ—Ä–µ–π–º–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <code>allow="camera; microphone"</code>.</li>
            <li>macOS: –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Üí –ö–∞–º–µ—Ä–∞ ‚Üí –≤–∫–ª—é—á–∏ –±—Ä–∞—É–∑–µ—Ä.</li>
          </ul>
        </div>
        <div id="log" class="monosmall"></div>
      </div>
    </main>
    <footer>
      <small class="tag">v2 ‚Äî —Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∏–≤–∞–µ–º –¥–∏–∞–ª–æ–≥. –ö–∞–∫ –ø–æ—è–≤–∏—Ç—Å—è ‚Äî –≤–µ—Ä–Ω—ë–º 3D‚Äë–∞–≤–∞—Ç–∞—Ä –∏ –∏–≥—Ä—É.</small>
    </footer>
  </div>

  <script>
    (function(){
      const qs = (s)=>document.querySelector(s);
      const startBtn=qs('#start');
      const startMinBtn=qs('#startMin');
      const retryBtn=qs('#retry');
      const stopBtn =qs('#stop');
      const copyBtn =qs('#copy');
      const statusEl=qs('#status');
      const diagEl  =qs('#diag');
      const videoEl =qs('#video');
      const logEl   =qs('#log');
      let stream=null;

      const isTop    = (window.top === window);
      const isSecure = window.isSecureContext || ['localhost','127.0.0.1','::1'].includes(location.hostname);
      const hasGUM   = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
      const ua       = navigator.userAgent;
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua);

      function tag(txt){ const s=document.createElement('span'); s.className='tag'; s.textContent=txt; return s; }
      function setStatus(msg, kind){ statusEl.textContent=msg; statusEl.className='tag '+(kind||''); }
      function log(msg){ const time=new Date().toLocaleTimeString(); logEl.textContent += `[${time}] ${msg}\n`; logEl.scrollTop = logEl.scrollHeight; }

      // Show env
      diagEl.append(tag('Top: '+(isTop?'‚úÖ':'‚ùå')));
      diagEl.append(tag('Secure: '+(isSecure?'‚úÖ':'‚ùå')));
      diagEl.append(tag('getUserMedia: '+(hasGUM?'‚úÖ':'‚ùå')));
      if(isSafari) diagEl.append(tag('Safari'));
      log(`protocol=${location.protocol}, host=${location.host}, isSecureContext=${window.isSecureContext}`);

      // Permissions API (–Ω–µ –≤–µ–∑–¥–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
      (async()=>{
        try{
          if(navigator.permissions && navigator.permissions.query){
            const p = await navigator.permissions.query({name:'camera'}).catch(()=>null);
            if(p){ diagEl.append(tag('perm:'+p.state)); log('permissions.camera='+p.state); p.onchange=()=>log('permissions.camera changed to '+p.state); }
          }
        }catch(e){ log('permissions.query(camera) unsupported: '+e); }
      })();

      // iOS flags before play()
      videoEl.muted = true; videoEl.setAttribute('muted','');
      videoEl.playsInline = true; videoEl.setAttribute('playsinline','');

      async function getStream(constraints){
        if(!isSecure) throw new Error('–ù—É–∂–µ–Ω HTTPS –∏–ª–∏ localhost ‚Äî –Ω–∞ http/file:// –¥–∏–∞–ª–æ–≥–∞ –Ω–µ –±—É–¥–µ—Ç');
        if(!hasGUM) throw new Error('getUserMedia –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
        try{
          const s = await navigator.mediaDevices.getUserMedia(constraints);
          videoEl.srcObject = s; await videoEl.play().catch(()=>{}); stream=s; return s;
        }catch(err){ throw err; }
      }

      async function startNormal(){
        setStatus('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –∫–∞–º–µ—Ä—É (–æ–±—ã—á–Ω—ã–π)‚Ä¶','warn'); log('startNormal() click');
        try{
          await getStream({ video: { facingMode:'user', width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30} }, audio:false });
          setStatus('–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞','ok'); stopBtn.disabled=false; videoEl.style.display='block';
        }catch(err){ handleErr(err, '–æ–±—ã—á–Ω—ã–π'); }
      }

      async function startMinimal(){
        setStatus('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –∫–∞–º–µ—Ä—É (–º–∏–Ω–∏–º—É–º)‚Ä¶','warn'); log('startMinimal() click');
        try{
          await getStream({ video: true, audio: false });
          setStatus('–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞ (–º–∏–Ω–∏–º—É–º)','ok'); stopBtn.disabled=false; videoEl.style.display='block';
        }catch(err){ handleErr(err, '–º–∏–Ω–∏–º—É–º'); }
      }

      function stopCam(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } videoEl.srcObject=null; videoEl.style.display='none'; setStatus('–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞','warn'); }

      function classifyErr(err){
        const s = String(err && (err.message||err.name) || err);
        let reason='unknown';
        if(/NotAllowedError|denied|Permission/i.test(s)) reason='denied';
        else if(/NotFoundError|device|videoinput|no camera|OverconstrainedError/i.test(s)) reason='notfound';
        else if(/NotReadableError|track|busy|in use/i.test(s)) reason='busy';
        else if(/secure|HTTPS|localhost|http:|file:\/\//i.test(s)) reason='insecure';
        else if(!isTop) reason='iframe';
        return {reason, s};
      }

      function handleErr(err, label){
        const {reason, s} = classifyErr(err);
        log(`ERROR(${label}): ${s}`);
        let msg = s;
        if(reason==='denied') msg='–î–æ—Å—Ç—É–ø –æ—Ç–∫–ª–æ–Ω—ë–Ω. –†–∞–∑—Ä–µ—à–∏ –∫–∞–º–µ—Ä—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∞–π—Ç–∞/–±—Ä–∞—É–∑–µ—Ä–∞ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
        if(reason==='notfound') msg='–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/—Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è (macOS: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å ‚Üí –ö–∞–º–µ—Ä–∞).';
        if(reason==='busy') msg='–ö–∞–º–µ—Ä–∞ –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π/–≤–∫–ª–∞–¥–∫–æ–π. –ó–∞–∫—Ä–æ–π –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Zoom/Meet/FaceTime) –∏ –ø–æ–≤—Ç–æ—Ä–∏.';
        if(reason==='insecure') msg='–ù—É–∂–µ–Ω HTTPS (–∏–ª–∏ localhost). –ù–∞ http/file:// –¥–∏–∞–ª–æ–≥ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è.';
        if(reason==='iframe') msg+=' (–ï—Å–ª–∏ —ç—Ç–æ iframe ‚Äî –¥–æ–±–∞–≤—å allow="camera; microphone")';
        setStatus('–û—à–∏–±–∫–∞: '+msg,'err');
      }

      // Buttons: attach both click and pointerup (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —Å–∞—Ñ–∞—Ä–∏)
      function bindPress(el, fn){ el.addEventListener('click', fn, {passive:true}); el.addEventListener('pointerup', fn, {passive:true}); }
      bindPress(startBtn, startNormal);
      bindPress(startMinBtn, startMinimal);
      bindPress(retryBtn, ()=>{ stopCam(); log('retry pressed'); setStatus('–ì–æ—Ç–æ–≤ –∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É','warn'); });
      stopBtn.addEventListener('click', stopCam);
      copyBtn.addEventListener('click', async()=>{
        const txt = `protocol=${location.protocol}\nhost=${location.host}\nisSecureContext=${window.isSecureContext}\nuserAgent=${navigator.userAgent}\n` + logEl.textContent;
        try{ await navigator.clipboard.writeText(txt); setStatus('–û—Ç—á—ë—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä','ok'); }catch{ setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç','err'); }
      });

      // Immediate hint if insecure
      if(!isSecure){ setStatus('–ù—É–∂–µ–Ω HTTPS –∏–ª–∏ localhost', 'err'); log('INSECURE CONTEXT'); }
    })();
  </script>
</body>
</html>
