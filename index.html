<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Full‚ÄëBody 3D Avatar ‚Ä¢ Camera ULTRA FIX</title>
  <meta name="theme-color" content="#0a0f1e"/>
  <style>
    :root{--bg:#060912;--fg:#e8edf6;--muted:#9fb1c9;--glass:rgba(255,255,255,.06);--brd:rgba(255,255,255,.12);--ok:#65f4b0;--warn:#ffd266;--err:#ff6b6b;--acc:#79c7ff}
    html,body{height:100%}
    body{margin:0;color:var(--fg);background:
      radial-gradient(1200px 800px at 70% 10%, #1b2340 0%, #0c1226 40%, #060912 100%),
      linear-gradient(160deg,#070b16,#0a1222);
      overflow:hidden;font:500 14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #stage{position:fixed;inset:0;display:block;width:100%;height:100%}

    /* HUD */
    #hud{position:fixed;inset:auto 0 0 0;display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;justify-content:center;padding:.7rem .9rem;background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.65));backdrop-filter:blur(8px);border-top:1px solid var(--brd)}
    .btn{appearance:none;border:1px solid var(--brd);background:var(--glass);color:var(--fg);padding:.65rem .9rem;border-radius:12px;cursor:pointer;transition:.2s;user-select:none}
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.12)}
    .seg{display:flex;gap:.4rem;align-items:center;border:1px solid var(--brd);background:var(--glass);padding:.45rem .65rem;border-radius:12px}
    .tag{display:inline-flex;gap:.35rem;align-items:center;padding:.25rem .6rem;border:1px solid var(--brd);border-radius:999px;background:var(--glass)}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}

    /* Overlay */
    #overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{max-width:980px;width:min(96vw,980px);background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));border:1px solid var(--brd);border-radius:18px;padding:18px 18px 16px;box-shadow:0 40px 120px rgba(0,0,0,.55)}
    .card h1{margin:.2rem 0 8px;font-weight:800;letter-spacing:.2px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    .muted{opacity:.8}
    .kbd{font-weight:700;background:rgba(255,255,255,.1);padding:.1rem .45rem;border-radius:6px;border:1px solid var(--brd)}
    #diag{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.6rem}

    #cam{position:fixed;right:12px;bottom:92px;width:280px;max-width:40vw;height:auto;border-radius:12px;display:none;border:1px solid var(--brd);box-shadow:0 16px 60px rgba(0,0,0,.6)}
    #debug{position:fixed;left:12px;bottom:92px;width:340px;max-width:44vw;height:auto;display:none;border-radius:12px;border:1px solid var(--brd)}
    #banner{position:fixed;top:10px;left:50%;transform:translateX(-50%);display:none;gap:.6rem;align-items:center;justify-content:center;padding:.55rem .8rem;border-radius:12px;border:1px solid var(--brd);background:rgba(255,170,0,.08)}
  </style>
  <!-- Core libs -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@3.5.0/dist/pose-detection.min.js"></script>
</head>
<body>
  <canvas id="stage"></canvas>

  <div id="hud">
    <button class="btn" id="start">‚ñ∂ –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
    <button class="btn" id="pause" disabled>‚è∏ –ü–∞—É–∑–∞</button>
    <button class="btn" id="dbg">üß© –û—Ç–ª–∞–¥–∫–∞</button>
    <button class="btn" id="toggleCam">üì∑ –ü—Ä–µ–≤—å—é</button>
    <div class="seg"><label>–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ</label><input id="smooth" type="range" min="0" max="0.98" step="0.02" value="0.55" /></div>
    <div class="seg"><label>–ö–∞—á–µ—Å—Ç–≤–æ</label><input id="dpr" type="range" min="1" max="2.5" step="0.25" value="1.5" /></div>
    <span class="tag" id="fps">FPS: --</span>
    <span class="tag" id="status">üü° –ì–æ—Ç–æ–≤–æ</span>
  </div>

  <div id="overlay">
    <div class="card">
      <h1>–ò–≥—Ä–∞ —Ç–µ–ª–æ–º + 3D‚Äë–∞–≤–∞—Ç–∞—Ä ‚Ä¢ ULTRA FIX</h1>
      <div class="grid">
        <div>
          <p>1) –ü–æ—Å—Ç–∞–≤—å –Ω–æ—É—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –≥—Ä—É–¥–∏, –æ—Ç–æ–π–¥–∏ –Ω–∞ 2‚Äì3 –º ‚Äî <b>–≤ –∫–∞–¥—Ä–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤—Å—ë —Ç–µ–ª–æ</b> (–≥–æ–ª–æ–≤–∞ –∏ —Å—Ç—É–ø–Ω–∏).</p>
          <p>2) –ù–∞–∂–º–∏ <span class="kbd">–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</span> ‚Äî –∑–∞–ø—Ä–æ—Å –ø–æ—è–≤–∏—Ç—Å—è. –ù–∞ iOS/Safari –Ω—É–∂–µ–Ω <b>HTTPS</b> –∏ —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª–∏–∫.</p>
          <p>3) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –Ω–∞–∫–ª–æ–Ω –ø–ª–µ—á ‚Äî –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ; —Ä—É–∫–∏ –≤–≤–µ—Ä—Ö ‚Äî –ø—Ä—ã–∂–æ–∫; –ø—Ä–∏—Å–µ–¥ ‚Äî —Å–ª–∞–π–¥. <span class="muted">–ü—Ä–æ–±–µ–ª ‚Äî –ø–µ—Ä–µ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞.</span></p>
        </div>
        <div>
          <p class="muted"><b>–ï—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ—Ç –¥–∏–∞–ª–æ–≥–∞:</b></p>
          <ul>
            <li>–û—Ç–∫—Ä–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ <b>HTTPS</b> –∏–ª–∏ —Å <b>localhost</b>. –ù–∞ http/file:// –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ –±—É–¥–µ—Ç.</li>
            <li>Safari: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –°–∞–π—Ç—ã ‚Üí –ö–∞–º–µ—Ä–∞ ‚Üí <b>–†–∞–∑—Ä–µ—à–∏—Ç—å</b>; –°–∏—Å—Ç–µ–º–∞ ‚Üí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å ‚Üí –ö–∞–º–µ—Ä–∞ ‚Üí –≤–∫–ª—é—á–∏ –±—Ä–∞—É–∑–µ—Ä.</li>
            <li>–ï—Å–ª–∏ —Ä–∞–Ω—å—à–µ –Ω–∞–∂–∞–ª(–∞) ¬´–ù–µ —Ä–∞–∑—Ä–µ—à–∞—Ç—å¬ª ‚Äî —Å–±—Ä–æ—Å—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∞–π—Ç–∞.</li>
            <li>–ï—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ <i>iframe</i>, —É —Ñ—Ä–µ–π–º–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <code>allow="camera; microphone"</code> (–∏–Ω–∞—á–µ –¥–∏–∞–ª–æ–≥–∞ –Ω–µ –±—É–¥–µ—Ç).</li>
          </ul>
        </div>
      </div>
      <div id="diag"></div>
    </div>
  </div>

  <div id="banner"></div>

  <video id="cam" playsinline muted autoplay></video>
  <canvas id="debug"></canvas>

  <script type="module">
    // ===== Preflight diagnostics (to guarantee prompt shows) =====
    const diag = document.getElementById('diag');
    const banner = document.getElementById('banner');
    function pill(text){ const s=document.createElement('span'); s.className='tag'; s.textContent=text; return s; }
    function showBanner(msg, type='warn'){ banner.textContent=msg; banner.className='tag '+type; banner.style.display='flex'; clearTimeout(showBanner._t); showBanner._t=setTimeout(()=> banner.style.display='none', 6000); }

    const isTop = (window.top === window);
    const isSecure = window.isSecureContext || ['localhost','127.0.0.1','::1'].includes(location.hostname);
    const ua = navigator.userAgent;
    const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
    const hasMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);

    diag.append(pill('Top‚Äëlevel: '+(isTop?'‚úÖ':'‚ùå')));
    diag.append(pill('Secure: '+(isSecure?'‚úÖ':'‚ùå')));
    diag.append(pill('Safari: '+(isSafari?'üü¢':'‚Äî')));
    diag.append(pill('getUserMedia: '+(hasMedia?'‚úÖ':'‚ùå')));

    if(!isSecure){
      const p=document.createElement('p'); p.className='muted'; p.innerHTML='–ù—É–∂–µ–Ω <b>HTTPS</b> –∏–ª–∏ <b>localhost</b>. –ù–∞ http/file:// –∫–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è.'; diag.append(p);
    }
    if(!isTop){
      const p=document.createElement('p'); p.className='muted'; p.innerHTML='–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–Ω—É—Ç—Ä–∏ <i>iframe</i>. –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ —Ñ—Ä–µ–π–º –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å <code>allow="camera; microphone"</code>.'; diag.append(p);
    }

    // ===== THREE.js scene (premium visual) =====
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
    import { EffectComposer } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/postprocessing/EffectComposer.js';
    import { RenderPass } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/postprocessing/UnrealBloomPass.js';
    import { SMAAPass } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/postprocessing/SMAAPass.js';

    const stage = document.getElementById('stage');
    const renderer = new THREE.WebGLRenderer({ canvas: stage, antialias: true, alpha: true });
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping; renderer.toneMappingExposure = 1.1;
    renderer.shadowMap.enabled = true; renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x050910, 0.05);

    const cam3d = new THREE.PerspectiveCamera(55, 1, 0.01, 300); cam3d.position.set(0,1.55,4.2);

    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, cam3d));
    const bloom = new UnrealBloomPass(new THREE.Vector2(1,1), 0.8, 0.7, 0.2); composer.addPass(bloom);
    const smaa = new SMAAPass(window.innerWidth, window.innerHeight); composer.addPass(smaa);

    // Lights
    const hemi = new THREE.HemisphereLight(0x9fc4ff, 0x0a0a12, 0.9); scene.add(hemi);
    const key = new THREE.DirectionalLight(0xffffff, 1.2); key.position.set(2,5,3); key.castShadow = true; scene.add(key);
    const rim = new THREE.DirectionalLight(0x63b8ff, 0.7); rim.position.set(-3,4,-2); scene.add(rim);

    // Premium floor: scrolling neon grid
    const gridGeo = new THREE.PlaneGeometry(40, 400, 40, 400);
    const gridMat = new THREE.ShaderMaterial({
      uniforms: { t: { value: 0 }, col1: { value: new THREE.Color('#0cc2ff') }, col2: { value: new THREE.Color('#00ffa8') } },
      transparent: true,
      vertexShader: `varying vec2 vUv; void main(){ vUv=uv; vec3 p=position; gl_Position=projectionMatrix*modelViewMatrix*vec4(p,1.0); }`,
      fragmentShader: `varying vec2 vUv; uniform float t; uniform vec3 col1; uniform vec3 col2; 
        float line(float v, float w){ float d=abs(fract(v)-.5); return smoothstep(w, 0.0, d); }
        void main(){ float z = vUv.y*40.0 + t*6.0; float x = vUv.x*20.0; 
          float g = max(line(z, .06), line(x, .08)); vec3 col = mix(col1,col2, vUv.y);
          gl_FragColor = vec4(col * g * 0.8, g*0.9);
        }`
    });
    const grid = new THREE.Mesh(gridGeo, gridMat); grid.rotation.x = -Math.PI/2; grid.position.y = 0; grid.receiveShadow = true; scene.add(grid);

    // Lane markers (subtle)
    const laneMat = new THREE.MeshStandardMaterial({ color: 0x0e2236, metalness:.4, roughness:.25, emissive:0x071a2a, emissiveIntensity: 1.3 });
    for (let i=-2;i<=2;i+=2){ const lane = new THREE.Mesh(new THREE.BoxGeometry(0.05, .01, 400), laneMat); lane.position.set(i, .005, 0); scene.add(lane); }

    // Avatar: glossy capsules + head with emissive visor
    const player = new THREE.Group(); scene.add(player);
    const limbMat = new THREE.MeshPhysicalMaterial({ color: 0x9ad8ff, metalness:.9, roughness:.1, clearcoat:1, clearcoatRoughness:.03, transmission:.04, thickness:.6, emissive:0x0a2740, emissiveIntensity:1.3 });
    const torsoMat = new THREE.MeshPhysicalMaterial({ color: 0x7df0c8, metalness:.8, roughness:.15, clearcoat:1, emissive:0x0b3a2a, emissiveIntensity:1.2 });
    const headMat  = new THREE.MeshPhysicalMaterial({ color: 0xffffff, metalness:.4, roughness:.25, emissive:0x111111, emissiveIntensity:.7 });

    function capsule(radius=0.06, height=1){
      const g = new THREE.CapsuleGeometry(radius, Math.max(0,height-2*radius), 12, 18);
      const m = new THREE.Mesh(g, limbMat); m.castShadow=true; m.frustumCulled=false; return m;
    }

    // Joints as tiny emissive spheres
    const joints = {}; const jnames=['nose','left_shoulder','right_shoulder','left_elbow','right_elbow','left_wrist','right_wrist','left_hip','right_hip','left_knee','right_knee','left_ankle','right_ankle','left_foot_index','right_foot_index'];
    jnames.forEach(n=>{ const s=new THREE.Mesh(new THREE.SphereGeometry(0.025), new THREE.MeshStandardMaterial({ color:0x6fb0ff, emissive:0x0a1f3a, emissiveIntensity:1.4 })); s.castShadow=false; player.add(s); joints[n]=s; });

    // Limbs built from capsules; we update scale+rotation per frame
    const limbs={};
    function makeLimb(){ const g=new THREE.Group(); const cap=capsule(); g.add(cap); g.userData.cap=cap; player.add(g); return g; }
    const limbPairs=[['left_shoulder','left_elbow'],['left_elbow','left_wrist'],['right_shoulder','right_elbow'],['right_elbow','right_wrist'],['left_hip','left_knee'],['left_knee','left_ankle'],['right_hip','right_knee'],['right_knee','right_ankle'],['left_shoulder','right_shoulder'],['left_hip','right_hip']];
    limbPairs.forEach(p=> limbs[p.join('-')] = makeLimb());

    // Torso: rounded box
    const torso = new THREE.Mesh(new THREE.BoxGeometry(0.45,0.6,0.25), torsoMat); torso.castShadow=true; player.add(torso);

    // Head + visor
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.13, 24, 18), headMat); head.castShadow=true; player.add(head);
    const visor = new THREE.Mesh(new THREE.TorusGeometry(0.14, 0.018, 16, 64), new THREE.MeshStandardMaterial({ color:0x79c7ff, metalness:.7, roughness:.2, emissive:0x0da2ff, emissiveIntensity:2 })); head.add(visor); visor.rotation.x=Math.PI/2;

    function updateCapsule(g,a,b){ const v=new THREE.Vector3().subVectors(b,a); const len=v.length(); const mid=new THREE.Vector3().addVectors(a,b).multiplyScalar(.5); g.position.copy(mid); const q=new THREE.Quaternion().setFromUnitVectors(new THREE.Vector3(0,1,0), v.clone().normalize()); g.setRotationFromQuaternion(q); const cap=g.userData.cap; cap.scale.set(1, Math.max(0.1,len), 1); }

    // Obstacles
    const obstacles=[]; const oGeo=new THREE.BoxGeometry(.6,.6,.6);
    function spawnObstacle(){ const m = new THREE.MeshStandardMaterial({ color:0x203d57, metalness:.6, roughness:.2, emissive:0x0a2030, emissiveIntensity: 1.8 }); const box=new THREE.Mesh(oGeo,m); box.castShadow=true; const laneX=[-2,0,2][Math.floor(Math.random()*3)]; box.position.set(laneX,.3,-22-Math.random()*12); scene.add(box); obstacles.push(box); }

    // Video + Pose
    const video = document.getElementById('cam'); // –º—ã –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º —Ñ–æ–Ω ‚Äî —Ç–æ–ª—å–∫–æ –∞–≤–∞—Ç–∞—Ä
    const dbg = document.getElementById('debug'); const dctx = dbg.getContext('2d');

    let detector=null, running=false, ema={}, smoothK=.55, showDebug=false, last=performance.now();
    const startBtn=document.getElementById('start'); const pauseBtn=document.getElementById('pause'); const dbgBtn=document.getElementById('dbg'); const toggleCamBtn=document.getElementById('toggleCam'); const smoothInput=document.getElementById('smooth'); const dprInput=document.getElementById('dpr'); const statusPill=document.getElementById('status'); const fpsPill=document.getElementById('fps');

    function setStatus(msg, cls=''){ statusPill.textContent=msg; statusPill.className='tag '+cls; }

    function fit(){ const w=innerWidth,h=innerHeight; const dpr=Number(dprInput.value)||1; renderer.setSize(w,h,false); renderer.setPixelRatio(dpr); cam3d.aspect=w/h; cam3d.updateProjectionMatrix(); composer.setSize(w,h); dbg.width=Math.min(520, Math.floor(w*.48)); dbg.height=Math.floor(dbg.width*9/16); }
    addEventListener('resize', fit); fit();

    smoothInput.oninput=()=> smoothK=Number(smoothInput.value);
    dprInput.oninput=fit;
    dbgBtn.onclick=()=>{ showDebug=!showDebug; dbg.style.display=showDebug?'block':'none'; };
    toggleCamBtn.onclick=()=>{ video.style.display=video.style.display==='none'?'block':'none'; };
    addEventListener('keydown', (e)=>{ if(e.code==='Space'){ ema={}; showBanner('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞','ok'); }});

    async function ensureDetector(){ const BlazePose = poseDetection.SupportedModels.BlazePose; detector = await poseDetection.createDetector(BlazePose,{ runtime:'mediapipe', solutionPath:'https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404', modelType:'heavy', enableSmoothing:true, minPoseScore:0.4 }); }

    async function requestCamera(){
      if(!isSecure) throw new Error('–ù—É–∂–µ–Ω HTTPS –∏–ª–∏ localhost');
      if(!navigator.mediaDevices?.getUserMedia) throw new Error('getUserMedia –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');

      // iOS/Safari —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è: video –≤ DOM, muted+playsinline –≤—ã—Å—Ç–∞–≤–ª–µ–Ω—ã –¥–æ play(); –≤—ã–∑–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–ª–∏–∫–∞
      video.setAttribute('muted',''); video.setAttribute('playsinline',''); video.muted=true; video.playsInline=true;

      // –ü—Ä–æ–≤–µ—Ä–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∑–∞—Ä–∞–Ω–µ–µ
      const devices = await navigator.mediaDevices.enumerateDevices().catch(()=>[]);
      const hasCam = devices.some(d=> d.kind==='videoinput');
      if(!hasCam) showBanner('–ö–∞–º–µ—Ä–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ (videoinput)', 'err');

      const constraints={video:{ facingMode:'user', width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30} }, audio:false};
      const stream= await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject=stream; await video.play().catch(()=>{});
      return stream;
    }

    startBtn.onclick = async ()=>{
      try{
        setStatus('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –∫–∞–º–µ—Ä—É‚Ä¶','warn');
        await requestCamera();
        setStatus('–ó–∞–≥—Ä—É–∂–∞—é —Ç—Ä–µ–∫–∏–Ω–≥‚Ä¶','warn');
        await ensureDetector();
        setStatus('–ö–∞–º–µ—Ä–∞ –æ–∫ ‚Ä¢ —Ç—Ä–µ–∫–∏–Ω–≥ –æ–∫','ok');
        running = true; startBtn.disabled=true; pauseBtn.disabled=false; document.getElementById('overlay').style.display='none';
      }catch(err){
        console.error(err);
        let msg = String(err && err.message || err);
        if(/NotAllowedError|denied|Permission/i.test(msg)) msg='–î–æ—Å—Ç—É–ø –æ—Ç–∫–ª–æ–Ω—ë–Ω. –†–∞–∑—Ä–µ—à–∏ –∫–∞–º–µ—Ä—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∞–π—Ç–∞/–±—Ä–∞—É–∑–µ—Ä–∞.';
        if(/secure|HTTPS|localhost/i.test(msg)) msg='–ù—É–∂–µ–Ω HTTPS (–∏–ª–∏ localhost). –ù–∞ http/file:// –∫–∞–º–µ—Ä–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.';
        if(/NotFoundError|device|videoinput/i.test(msg)) msg='–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã.';
        if(!isTop) msg+=' (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ iframe –±–µ–∑ allow="camera")';
        setStatus('–û—à–∏–±–∫–∞: '+msg,'err'); showBanner('‚ùå '+msg,'err');
      }
    };

    pauseBtn.onclick=()=>{ running=!running; pauseBtn.textContent=running?'‚è∏ –ü–∞—É–∑–∞':'‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å'; };

    // Pose mapping
    const V3=THREE.Vector3; function lerp(a,b,t){return a+(b-a)*t};
    function vOf(name, list){ const k=list.find(p=>p.name===name)||list[0]; const out=new V3(k.x||0, k.y||0, k.z||0); out.set(out.x, -out.y, -out.z); return out; }
    function smooth(name, cur){ const prev=ema[name]||cur.clone(); const out=prev.clone().lerp(cur, 1-smoothK); ema[name]=out.clone(); return out; }

    function updateFromPose(pose){ if(!pose) return; const k2=pose.keypoints||[]; const k3=pose.keypoints3D?.length?pose.keypoints3D:k2.map(k=>({name:k.name,x:k.x/(video.videoWidth||1),y:k.y/(video.videoHeight||1),z:0}));
      const j={}; for(const n of jnames){ j[n]=smooth(n, vOf(n,k3)); joints[n].position.copy(j[n]); }
      const hip = smooth('hip_center', j.left_hip.clone().add(j.right_hip).multiplyScalar(.5));
      const sh  = smooth('shoulder_center', j.left_shoulder.clone().add(j.right_shoulder).multiplyScalar(.5));

      // scale avatar to person height
      const feetY = Math.max(j.left_foot_index.y, j.right_foot_index.y, j.left_ankle.y, j.right_ankle.y);
      const headY = Math.min(j.nose.y, j.left_shoulder.y-0.25, j.right_shoulder.y-0.25);
      const height=Math.max(.6, (feetY-headY)); const scale=1.8/height; player.scale.lerp(new THREE.Vector3(scale,scale,scale), .15);

      // limbs and torso
      limbPairs.forEach(([a,b])=> updateCapsule(limbs[a+'-'+b], j[a], j[b]));
      torso.position.copy(sh.clone().add(hip).multiplyScalar(.5)); torso.scale.set(1, j.left_shoulder.distanceTo(j.right_shoulder)*1.6, 1);
      const span = j.left_shoulder.distanceTo(j.right_shoulder);
      head.position.copy(j.nose.clone().add(new V3(0, span*.38, 0))); head.scale.setScalar(THREE.MathUtils.clamp(span*0.75, 0.12, 0.38));

      // control
      const lean = THREE.MathUtils.clamp((j.right_shoulder.y - j.left_shoulder.y)*3.5, -1.5, 1.5); player.position.x = lerp(player.position.x, lean*2.2, .15);
      const wristsUp = (Math.min(j.left_wrist.y, j.right_wrist.y) < (head.position.y - span*0.15)); if(wristsUp && player.userData.grounded!==false){ player.userData.vy=0.2; player.userData.grounded=false; }
      player.userData.duck = (hip.y < sh.y - span*0.62);
    }

    // Simple physics + gameplay
    function updatePhysics(dt){ const g=-0.95; player.userData.vy=(player.userData.vy||0)+g*dt; const y=(player.position.y||0)+(player.userData.vy||0); if(y<=0){ player.position.y=0; player.userData.vy=0; player.userData.grounded=true; } else { player.position.y=y; } }
    let score=0, spawnAcc=0;

    function loop(){ requestAnimationFrame(loop); const now=performance.now(); const dt=Math.min(.05,(now-last)/1000); last=now;
      gridMat.uniforms.t.value += dt;
      (async()=>{ if(running && detector && video.readyState>=2){ try{ const poses = await detector.estimatePoses(video,{flipHorizontal:true}); updateFromPose(poses[0]); }catch(e){} } })();
      if(running){ updatePhysics(dt); spawnAcc+=dt; if(spawnAcc>1.05){ spawnAcc=0; spawnObstacle(); }
        for(let i=obstacles.length-1;i>=0;i--){ const o=obstacles[i]; o.position.z += 6*dt; const px=player.position.x, py=player.position.y+1.0; if(Math.abs(o.position.x-px)<.46 && Math.abs(o.position.z-0)<.42){ const duck=player.userData.duck; const jumping=py>0.85; if(!(duck||jumping)){ for(const x of obstacles){ scene.remove(x); } obstacles.length=0; score=0; setStatus('–°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ ‚Äî —Å—á—ë—Ç: 0','err'); break; } } if(o.position.z>3){ scene.remove(o); obstacles.splice(i,1); score++; setStatus('–°—á—ë—Ç: '+score,'ok'); } }
      }
      composer.render(); const fps=Math.round(1000/(now-(loop._last||now-16))); loop._last=now; fpsPill.textContent='FPS: '+fps;
      if(showDebug){ try{ dctx.globalAlpha=.35; dctx.drawImage(video,0,0,dbg.width,dbg.height); dctx.globalAlpha=1; dctx.fillStyle='#fff'; dctx.font='12px system-ui'; dctx.fillText('–û—Ç–ª–∞–¥–∫–∞ ‚Äî –∫–∞–º–µ—Ä–∞ + –ø–æ–∑–∞',8,18);}catch{} }
    }
    loop();

    const ro=new ResizeObserver(()=>fit()); ro.observe(document.body);
  </script>
</body>
</html>
