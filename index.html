<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CAMERA BASELINE ‚Äî –∑–∞–ø—Ä–æ—Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω</title>
  <style>
    :root{--bg:#0a0e19;--fg:#eaf0ff;--muted:#9eb2d2;--ok:#66f2b0;--warn:#ffd166;--err:#ff6b6b;--glass:rgba(255,255,255,.06);--brd:rgba(255,255,255,.14)}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 70% 10%, #162037 0%, #0a0e19 40%, #060912 100%);color:var(--fg);font:500 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto}
    header{padding:14px 16px;border-bottom:1px solid var(--brd);background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));backdrop-filter:blur(8px)}
    h1{margin:0;font-size:18px}
    main{display:grid;place-items:center;padding:16px}
    .panel{max-width:880px;width:min(96vw,880px);border:1px solid var(--brd);border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));box-shadow:0 30px 120px rgba(0,0,0,.55);padding:16px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{appearance:none;border:1px solid var(--brd);background:var(--glass);color:var(--fg);padding:.7rem 1rem;border-radius:12px;cursor:pointer;transition:.15s}
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.12)}
    .btn[disabled]{opacity:.5;cursor:not-allowed;transform:none}
    .tag{display:inline-flex;gap:.35rem;align-items:center;padding:.25rem .6rem;border:1px solid var(--brd);border-radius:999px;background:var(--glass)}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}
    #status{margin-left:auto}
    #video{width:min(85vw,720px);max-height:65vh;border-radius:12px;border:1px solid var(--brd);display:none;box-shadow:0 16px 60px rgba(0,0,0,.6)}
    #notes{opacity:.85;margin-top:12px}
    footer{padding:10px 16px;display:flex;gap:8px;justify-content:center}
    .hide{display:none !important}
    /* –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å: –∫–Ω–æ–ø–∫–∏ –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
    header, .panel, footer{z-index:10; position:relative}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>CAMERA BASELINE ‚Äî —á–∏—Å—Ç—ã–π —Å—Ç–∞—Ä—Ç (–∫–Ω–æ–ø–∫–∞ –∫–ª–∏–∫–∞–µ—Ç—Å—è, –∑–∞–ø—Ä–æ—Å –ø–æ—è–≤–ª—è–µ—Ç—Å—è)</h1>
    </header>

    <main>
      <div class="panel">
        <div class="row" style="margin-bottom:10px">
          <button id="start" class="btn">‚ñ∂ –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
          <button id="stop" class="btn" disabled>‚èπ –û—Ç–∫–ª—é—á–∏—Ç—å</button>
          <button id="toggle" class="btn" disabled>üì∑ –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é</button>
          <span id="status" class="tag warn">–ì–æ—Ç–æ–≤–æ</span>
        </div>
        <div id="diag" class="row" style="gap:6px;flex-wrap:wrap"></div>
        <video id="video" playsinline muted></video>
        <div id="notes">
          <ul>
            <li>–ó–∞–ø—Ä–æ—Å –∫ –∫–∞–º–µ—Ä–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è <b>—Ç–æ–ª—å–∫–æ</b> –Ω–∞ <b>HTTPS</b> –∏–ª–∏ <b>localhost</b>. –ù–∞ <code>file://</code> –∏ <code>http://</code> ‚Äî –¥–∏–∞–ª–æ–≥–∞ –Ω–µ –±—É–¥–µ—Ç –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –±—Ä–∞—É–∑–µ—Ä–æ–≤.</li>
            <li>–ï—Å–ª–∏ —Ä–∞–Ω—å—à–µ –Ω–∞–∂–∏–º–∞–ª(–∞) ¬´–ù–µ —Ä–∞–∑—Ä–µ—à–∞—Ç—å¬ª, —Å–±—Ä–æ—Å—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∞–π—Ç–∞ (–∑–Ω–∞—á–æ–∫ –∑–∞–º–∫–∞ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ).</li>
            <li>–ï—Å–ª–∏ —ç—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–Ω—É—Ç—Ä–∏ <i>iframe</i>, —É —Ñ—Ä–µ–π–º–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <code>allow="camera; microphone"</code>.</li>
          </ul>
        </div>
      </div>
    </main>

    <footer>
      <small class="tag">v1.0 ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –±–∞–∑–∞. –ö–æ–≥–¥–∞ –∫–∞–º–µ—Ä–∞ –æ–∫ ‚Äî –¥–æ–±–∞–≤–∏–º 3D‚Äë–∞–≤–∞—Ç–∞—Ä –∏ –∏–≥—Ä—É.</small>
    </footer>
  </div>

  <script>
    (function(){
      const startBtn = document.getElementById('start');
      const stopBtn  = document.getElementById('stop');
      const toggleBtn= document.getElementById('toggle');
      const statusEl = document.getElementById('status');
      const diagEl   = document.getElementById('diag');
      const videoEl  = document.getElementById('video');
      let stream = null;

      // ===== –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–¥–æ –∫–ª–∏–∫–∞) =====
      const isTop    = (window.top === window);
      const isSecure = window.isSecureContext || ['localhost','127.0.0.1','::1'].includes(location.hostname);
      const hasGUM   = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
      const ua       = navigator.userAgent;
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua);

      function tag(txt){ const s=document.createElement('span'); s.className='tag'; s.textContent=txt; return s; }
      diagEl.append(tag('Top: '+(isTop?'‚úÖ':'‚ùå')));
      diagEl.append(tag('Secure: '+(isSecure?'‚úÖ':'‚ùå')));
      diagEl.append(tag('getUserMedia: '+(hasGUM?'‚úÖ':'‚ùå')));
      if(isSafari) diagEl.append(tag('Safari'));

      function setStatus(msg, kind){ statusEl.textContent = msg; statusEl.className = 'tag ' + (kind||''); }

      // ===== –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –¥–ª—è iOS –ø–µ—Ä–µ–¥ play() =====
      videoEl.muted = true; videoEl.setAttribute('muted','');
      videoEl.playsInline = true; videoEl.setAttribute('playsinline','');

      async function startCamera(){
        if(!isSecure) throw new Error('–ù—É–∂–µ–Ω HTTPS –∏–ª–∏ localhost ‚Äî –Ω–∞ http/file:// –∫–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è');
        if(!hasGUM) throw new Error('navigator.mediaDevices.getUserMedia –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–∏–¥–µ–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∑–∞—Ä–∞–Ω–µ–µ
        try{
          const devices = await navigator.mediaDevices.enumerateDevices();
          const hasCam = devices.some(d=>d.kind === 'videoinput');
          if(!hasCam) throw new Error('–ö–∞–º–µ—Ä–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ (videoinput)');
        }catch(e){ /* enumerateDevices –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏–º, –ø—É—Å—Ç—å —Å–ø—Ä–æ—Å–∏—Ç */ }

        const constraints = { video: { facingMode: 'user', width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30} }, audio: false };
        const s = await navigator.mediaDevices.getUserMedia(constraints);
        videoEl.srcObject = s;
        await videoEl.play().catch(()=>{});
        stream = s;
      }

      function stopCamera(){
        if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
        videoEl.srcObject = null;
      }

      // ===== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–≤–Ω—É—Ç—Ä–∏ –∫–ª–∏–∫–∞ ‚Äî –≤–∞–∂–Ω–æ –¥–ª—è –ø–æ–ª–∏—Ç–∏–∫ –±—Ä–∞—É–∑–µ—Ä–æ–≤) =====
      startBtn.addEventListener('click', async ()=>{
        try{
          setStatus('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –∫–∞–º–µ—Ä—É‚Ä¶','warn');
          startBtn.disabled = true;
          await startCamera();
          setStatus('–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞','ok');
          stopBtn.disabled = false; toggleBtn.disabled = false; videoEl.style.display = 'block';
        }catch(err){
          console.error(err);
          startBtn.disabled = false;
          let msg = String(err && err.message || err);
          if(/NotAllowedError|denied|Permission/i.test(msg)) msg = '–î–æ—Å—Ç—É–ø –æ—Ç–∫–ª–æ–Ω—ë–Ω. –†–∞–∑—Ä–µ—à–∏ –∫–∞–º–µ—Ä—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∞–π—Ç–∞/–±—Ä–∞—É–∑–µ—Ä–∞.';
          if(/secure|HTTPS|localhost|http\:|file\:\/\//i.test(msg)) msg = '–ù—É–∂–µ–Ω HTTPS (–∏–ª–∏ localhost). –ù–∞ http/file:// –∫–∞–º–µ—Ä–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.';
          if(/NotFoundError|device|videoinput|camera not found/i.test(msg)) msg = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/—Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.';
          if(window.top !== window) msg += ' (–µ—Å–ª–∏ —ç—Ç–æ iframe ‚Äî –¥–æ–±–∞–≤—å allow="camera; microphone")';
          setStatus('–û—à–∏–±–∫–∞: '+msg, 'err');
        }
      });

      stopBtn.addEventListener('click', ()=>{
        stopCamera();
        setStatus('–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞','warn');
        stopBtn.disabled = true; toggleBtn.disabled = true; videoEl.style.display = 'none';
        startBtn.disabled = false;
      });

      toggleBtn.addEventListener('click', ()=>{
        const vis = videoEl.style.display !== 'none';
        videoEl.style.display = vis ? 'none' : 'block';
        toggleBtn.textContent = vis ? 'üì∑ –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é' : 'üì∑ –°–∫—Ä—ã—Ç—å –ø—Ä–µ–≤—å—é';
      });

      // –ü–æ—è—Å–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ç–æ—á–Ω–æ –Ω–µ secure
      if(!isSecure){ setStatus('–ù—É–∂–µ–Ω HTTPS –∏–ª–∏ localhost', 'err'); }
    })();
  </script>
</body>
</html>
